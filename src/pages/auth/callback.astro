---
/**
 * Auth Callback Handler
 * Obsługuje callbacks z Supabase (głównie password reset w MVP)
 * W przyszłości będzie obsługiwać także email verification i social auth
 *
 * Flow:
 * 1. Supabase wysyła email z linkiem
 * 2. Link prowadzi tutaj z tokenami w hash
 * 3. Ustawiamy session w Supabase
 * 4. Przekierowujemy w zależności od typu
 *
 * Types:
 * - recovery: Password reset → /reset-password
 * - signup: Email verification (przyszłość) → /generate
 */

const supabase = Astro.locals.supabase;

// Pobierz hash z URL (Supabase używa hash routing #access_token=...)
// W Astro musimy przekierować do client-side script, który odczyta hash
---

<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Przekierowywanie...</title>
    <script>
      // Client-side handling hash params (Supabase używa hash routing)
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);

      const accessToken = params.get('access_token');
      const refreshToken = params.get('refresh_token');
      const type = params.get('type');
      const error = params.get('error');
      const errorDescription = params.get('error_description');

      if (error) {
        console.error('Auth callback error:', error, errorDescription);

        if (error === 'access_denied') {
          window.location.href = '/login?error=link_expired';
        } else {
          window.location.href = '/login?error=auth_callback_failed';
        }
      } else if (accessToken && refreshToken) {
        // Mamy tokeny - ustaw session przez API
        fetch('/api/auth/set-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            access_token: accessToken,
            refresh_token: refreshToken,
          }),
        })
          .then((res) => {
            if (!res.ok) throw new Error('Failed to set session');
            return res.json();
          })
          .then(() => {
            // Zapisz do localStorage
            localStorage.setItem('access_token', accessToken);
            localStorage.setItem('refresh_token', refreshToken);

            // Przekieruj w zależności od typu
            if (type === 'recovery') {
              // Password reset - przekieruj do formularza zmiany hasła
              window.location.href = '/reset-password';
            } else if (type === 'signup') {
              // Email verification (przyszłość - obecnie wyłączone w MVP)
              window.location.href = '/generate?verified=true';
            } else {
              // Default redirect
              window.location.href = '/generate';
            }
          })
          .catch((error) => {
            console.error('Error setting session:', error);
            window.location.href = '/login?error=auth_callback_failed';
          });
      } else {
        // Brak tokenów - nieprawidłowy callback
        console.error('No tokens in callback');
        window.location.href = '/login?error=invalid_callback';
      }
    </script>
  </head>
  <body class="flex items-center justify-center min-h-screen bg-background">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
      <p class="text-muted-foreground">Przekierowywanie...</p>
    </div>
  </body>
</html>
