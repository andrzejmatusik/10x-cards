---
/**
 * Reset Password Page
 * Strona do ustawiania nowego hasła po kliknięciu w link z emaila
 *
 * Query params:
 * - token: Token z emaila (opcjonalny - sesja z callback)
 *
 * Flow:
 * 1. Użytkownik klika link w emailu
 * 2. Callback ustawia session
 * 3. Ta strona pozwala ustawić nowe hasło
 * 4. Po sukcesie → redirect na /login
 */

import Layout from '@/layouts/Layout.astro';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

// Sprawdź czy jest sesja (po callback)
const { data } = await Astro.locals.supabase.auth.getSession();

if (!data.session) {
  // Brak sesji - link wygasł lub nieprawidłowy
  return Astro.redirect('/login?error=reset_link_expired');
}
---

<Layout title="Zresetuj hasło - 10x-cards">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-2">Ustaw nowe hasło</h1>
        <p class="text-muted-foreground">
          Wprowadź nowe hasło dla swojego konta
        </p>
      </div>

      <!-- Reset Password Form Component -->
      <div id="reset-password-root"></div>
    </div>
  </div>
</Layout>

<script>
  import { AuthService } from '@/services/auth-service';

  // Client-side form handling
  const root = document.getElementById('reset-password-root');
  if (!root) throw new Error('Root element not found');

  // Render form
  root.innerHTML = `
    <div class="border rounded-lg shadow-lg">
      <div class="p-6 space-y-6 bg-card">
        <form id="reset-form" class="space-y-4">
          <div class="space-y-2">
            <label for="password" class="text-sm font-medium">
              Nowe hasło
            </label>
            <input
              type="password"
              id="password"
              name="password"
              minlength="8"
              required
              placeholder="••••••••"
              class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
            />
            <p class="text-xs text-muted-foreground">Minimum 8 znaków</p>
          </div>

          <div class="space-y-2">
            <label for="confirm-password" class="text-sm font-medium">
              Potwierdź hasło
            </label>
            <input
              type="password"
              id="confirm-password"
              name="confirmPassword"
              minlength="8"
              required
              placeholder="••••••••"
              class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
            />
          </div>

          <div id="error-message" class="hidden text-sm text-destructive bg-destructive/10 p-3 rounded-md"></div>

          <button
            type="submit"
            id="submit-btn"
            class="w-full bg-primary text-primary-foreground py-2 px-4 rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50"
          >
            Zmień hasło
          </button>
        </form>
      </div>
    </div>
  `;

  // Handle form submission
  const form = document.getElementById('reset-form') as HTMLFormElement;
  const errorDiv = document.getElementById('error-message');
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const password = (form.elements.namedItem('password') as HTMLInputElement).value;
    const confirmPassword = (form.elements.namedItem('confirmPassword') as HTMLInputElement).value;

    // Validation
    if (password.length < 8) {
      showError('Hasło musi mieć co najmniej 8 znaków');
      return;
    }

    if (password !== confirmPassword) {
      showError('Hasła nie są identyczne');
      return;
    }

    // Show loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Zmiana hasła...';
    hideError();

    try {
      await AuthService.updatePassword(password);

      // Success - redirect to login
      window.location.href = '/login?password_reset=success';
    } catch (error: any) {
      showError(error.message || 'Nie udało się zmienić hasła. Spróbuj ponownie');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Zmień hasło';
    }
  });

  function showError(message: string) {
    if (errorDiv) {
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }
  }

  function hideError() {
    if (errorDiv) {
      errorDiv.classList.add('hidden');
    }
  }
</script>
